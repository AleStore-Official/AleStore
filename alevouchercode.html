<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AleVoucher Envelope - AleStore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(135deg, #d7ccc8, #f5f5f5);
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #333;
    }
    .envelope {
      position: relative;
      width: 90vw;
      max-width: 600px;
      height: 60vh;
      background: #fff8dc;
      border: 3px solid #d2b48c;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      border-radius: 6px;
      overflow: hidden;
    }
    .flap {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 40%;
      background: linear-gradient(180deg, #f7e9c7, #e8d4a7);
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 2;
      transition: transform 1.2s ease-in-out;
      transform-origin: top center;
    }
    .seal {
      width: 80px;
      height: 80px;
      background: #8b0000;
      border-radius: 50%;
      position: absolute;
      top: 25%;
      left: calc(50% - 40px);
      box-shadow: 0 0 12px rgba(0,0,0,0.6);
      z-index: 3;
      transition: opacity 0.8s ease;
    }
    .content {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      font-weight: bold;
      color: #2ecc71;
      opacity: 0;
      transition: opacity 1s ease;
      padding: 20px;
      text-align: center;
    }
    .error {
      color: #e74c3c;
      font-size: 22px;
      font-weight: bold;
    }
    .hint {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #555;
    }
    .copy-btn {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: #3498db;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <div class="envelope" id="envelope">
    <div class="flap" id="flap"></div>
    <div class="seal" id="seal"></div>
    <div class="content" id="voucherCode"></div>
    <button class="copy-btn" id="copyBtn">Copy Code</button>
    <div class="hint">Swipe left ↔ right on the flap 4 times to open</div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const supabase = createClient(
      "https://hsyyrcbibohwvbuwxwok.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzeXlyY2JpYm9od3ZidXd4d29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjE0MDcsImV4cCI6MjA3NjYzNzQwN30.2KsFsGYjwf_cA7Z9oglVthiaE1_jWYuQ6HMMm5UXsyo"
    );

    const flap = document.getElementById("flap");
    const seal = document.getElementById("seal");
    const voucherCodeEl = document.getElementById("voucherCode");
    const copyBtn = document.getElementById("copyBtn");

    let swipeCount = 0;
    let startX = null;

    flap.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
    });

    flap.addEventListener("touchend", e => {
      if (startX !== null) {
        const endX = e.changedTouches[0].clientX;
        if (Math.abs(endX - startX) > 60) {
          swipeCount++;
          if (swipeCount >= 4) openEnvelope();
        }
      }
      startX = null;
    });

    async function openEnvelope() {
      const { data, error } = await supabase
        .from("voucher_codes")
        .select("code")
        .eq("enabled", true)
        .eq("used", false)
        .limit(1)
        .single();

      seal.style.opacity = 0;
      flap.style.transform = "rotateX(-120deg)";

      if (error || !data) {
        voucherCodeEl.textContent = "❌ No active voucher available";
        voucherCodeEl.classList.add("error");
      } else {
        voucherCodeEl.textContent = data.code;
        copyBtn.style.display = "block";
      }
      voucherCodeEl.style.opacity = 1;
    }

    copyBtn.addEventListener("click", () => {
      const code = voucherCodeEl.textContent;
      navigator.clipboard.writeText(code).then(() => {
        copyBtn.textContent = "Copied!";
        setTimeout(() => copyBtn.textContent = "Copy Code", 1200);
      });
    });
  </script>

  <script src="https://alestore-official.github.io/AleCAPTCHA/control.js"></script>
  <script type="module">
    import { blockIfUnauthorized } from "https://alestore-official.github.io/AleRegister/access.js";
    blockIfUnauthorized();
  </script>
</body>
</html>